name: Weekly Pokemon TCG Pocket Meta Analysis

on:
  schedule:
    # æ¯é€±é‡‘æ›œæ—¥15:00 JST (UTC: 6:00)
    - cron: '0 6 * * 5'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  weekly-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run weekly meta analysis
        run: npm run weekly-report
        env:
          TZ: 'Asia/Tokyo'

      - name: Commit and push results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          git add weekly-reports/
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          REPORT_DATE=$(date +'%Y-%m-%d' --date='Asia/Tokyo')
          git commit -m "ğŸ—“ï¸ Weekly Report: $REPORT_DATE

          ğŸ“Š Environment-Adaptive Meta Score Analysis
          ğŸ“… Generated: $(date +'%Y/%m/%d %H:%M' --date='Asia/Tokyo')
          ğŸ¯ Coverage: Tier 40 decks analysis
          âš”ï¸ Matchup data: Full collection
          ğŸ¤– Generated with Claude Code"
          
          git push
        env:
          TZ: 'Asia/Tokyo'

      - name: Create Release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: weekly-${{ github.run_number }}
          release_name: "é€±æ¬¡ç’°å¢ƒåˆ†æãƒ¬ãƒãƒ¼ãƒˆ - ${{ github.run_date }}"
          body: |
            ## ğŸ—“ï¸ é€±æ¬¡ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ç’°å¢ƒåˆ†æãƒ¬ãƒãƒ¼ãƒˆ
            
            **ç”Ÿæˆæ—¥æ™‚**: ${{ github.run_date }}
            **ç’°å¢ƒé©å¿œå‹ãƒ¡ã‚¿ã‚¹ã‚³ã‚¢ç®—å‡ºæ³•ã«ã‚ˆã‚‹åˆ†æ**
            
            ### ğŸ“Š åˆ†æå†…å®¹
            - âœ… 40ãƒ‡ãƒƒã‚­ç¶²ç¾…çš„ãƒ‡ãƒ¼ã‚¿åé›†
            - âœ… å…¨ç›¸æ€§ãƒ‡ãƒ¼ã‚¿åé›†
            - âœ… éš ã‚Œå¼·ãƒ‡ãƒƒã‚­ç™ºè¦‹
            - âœ… ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæ¨å¥¨æ§‹æˆ
            
            ### ğŸ“‚ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
            - `data/latest_report.md` - è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
            - `data/latest.json` - ç”Ÿãƒ‡ãƒ¼ã‚¿
            - `weekly-reports/` - é€±æ¬¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
            
            ---
            ğŸ¤– *ç’°å¢ƒé©å¿œå‹ãƒ¡ã‚¿ã‚¹ã‚³ã‚¢ç®—å‡ºæ³•ã«ã‚ˆã‚‹è‡ªå‹•åˆ†æ*
          draft: false
          prerelease: false